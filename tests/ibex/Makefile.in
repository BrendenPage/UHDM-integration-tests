IBEX = ${root_dir}/tests/ibex/ibex
#############################
####      SYNTHESIS      ####
#############################
uhdm/yosys/synth-ibex: image/bin/yosys clean-build
	virtualenv ${root_dir}/venv-ibex
	(. ${root_dir}/venv-ibex/bin/activate && \
		pip install -r ${IBEX}/python-requirements.txt && \
		pip install git+https://github.com/antmicro/edalize@surelog && \
		fusesoc --cores-root=${IBEX} run --target=synth --setup lowrisc:ibex:top_artya7 --part xc7a35ticsg324-1L && \
		export PATH=${root_dir}/image/bin:${PATH} && \
	        python ${root_dir}/surelog_yosys.py --tool yosys)

uhdm/yosys/synth-ibex-build: image/bin/yosys clean-build
	virtualenv ${root_dir}/venv-ibex
	(. ${root_dir}/venv-ibex/bin/activate && \
		pip install -r ${IBEX}/python-requirements.txt && \
		pip install git+https://github.com/antmicro/edalize@surelog && \
		fusesoc --cores-root=${IBEX} run --target=synth --setup lowrisc:ibex:top_artya7 --part xc7a35ticsg324-1L && \
		export PATH=${root_dir}/image/bin:${PATH} && \
	        python ${root_dir}/surelog_yosys.py --tool vivado)

#############################
#### SIMULATION  (YOSYS) ####
#############################

IBEX_TOP_DIR := ${root_dir}/tests/ibex/top
SIM_FILE ?= ibex_alu.sv
SIM_FILES := $(IBEX_DIR)/$(SIM_FILE)
ifeq ($(SIM_FILE),ibex_alu.sv)
	SIM_FILES := $(SIM_FILES) $(IBEX_TOP_DIR)/ibex_alu_top.sv $(IBEX_DIR)/ibex_pkg.sv
endif

surelog/parse-sim: image/bin/surelog
	mkdir -p build
	(cd build && \
		${SURELOG_BIN} -parse -sverilog \
			-I${root_dir}/tests/ibex/ibex/rtl \
			$(SIM_FILES) \
	)
	cp build/slpp_all/surelog.uhdm build/top.uhdm

uhdm/yosys/test-sim: surelog/parse-sim image/bin/yosys
	${YOSYS_BIN} \
		-p 'read_uhdm -debug build/top.uhdm' \
		-p 'prep -auto-top' \
		-p 'sim -clock clk -rstlen 10 -vcd dump.vcd'
